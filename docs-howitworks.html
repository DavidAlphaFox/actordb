<!DOCTYPE html>
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head prefix="og: http://ogp.me/ns#">
        <!--<meta charset="utf-8">-->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>ActorDB | Documentation</title>        
        <meta name="description" content="ActorDB is strongly consistent, distributed and horizontally scalable. Unlike traditional monolithic databases, ActorDB is made out of any number of independent and concurrent SQL databases called actors.">
        <meta name="viewport" content="width=device-width">
        <meta property="og:title" content="ActorDB | Documentation" />
        <meta property="og:description" content="ActorDB is strongly consistent, distributed and horizontally scalable. Unlike traditional monolithic databases, ActorDB is made out of any number of independent and concurrent SQL databases called actors." />
        <meta property="og:site_name" content="ActorDB" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://www.actordb.com/" />
        <meta property="og:image" content="http://www.actordb.com/imgs/actordb_fb_logo.png" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/actordb-website.css">
        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <script src="js/vendor/jquery-1.10.1.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic' rel='stylesheet' type='text/css'>
        <style>
            .block {
                display:block !Important;
            }
        </style>
        <script>
            $(document).ready(function(){
                $("#mobile_menu").click(function(evt){
                    $(this).siblings(".navigation").toggleClass("block");
                });
            });
        </script>
        <!--[if gte IE 9]>
          <style type="text/css">
            .gradient {filter: none;}
          </style>
        <![endif]-->
    </head>    
    <body id="view320logo" >
        <!--[if lt IE 9]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
        <div class="header">
            <div class="pagewrapper clearfix">
                <a href="" class="global-header_logo"></a>
                <a href="" class="global320-header_logo_text global-header_logo_text"></a>
                <ul class="navigation">
                    <li ><a href="index.html">Home</a></li>
                    <li  class="sel"><a href="docs-about.html">Documentation</a></li>
                    <li><a target="_blank" href="https://www.github.com/biokoda/actordb">Source</a></li>
                    <li class=" "><a href="downloads.html">Downloads</a></li>
                    <!-- <li class="  right"><a target="_blank" href="downloads.html">Downloads</a></li> -->
                </ul>
                <span id="mobile_menu" class="menu"></span>
            </div>
        </div>

        <script>
$(document).ready(function(){
    $(".collapsed > .title").click(function(evt){        
        $(this).parent().toggleClass("expanded");
        return false;
    });
});
</script>
<div class="pagecontainer">
    <div class="pagewrapper clearfix">
        <div class="leftmenu">

            <div class="l1">
                <a href="docs-about.html" class="title">
                    <span class="text">1. ABOUT</span>
                </a>
            </div>
            <div class="l1 collapsed ">
                <a href="docs-getstarted.html" class="title">
                    <span class="bullet"></span>
                    <span class="text">2. GET STARTED</span>
                </a>
                <div class="l2">
                    <a href="docs-getstarted.html#download_run" class="title">
                        <span class="text">2.1 Download and run ActorDB</span>
                    </a>
                    <a href="docs-getstarted.html#run" class="title">
                        <span class="text">2.2 Run ActorDB</span>
                    </a>
                    <a href="docs-getstarted.html#insertandquery" class="title">
                        <span class="text">2.3 Simple insert and query data</span>
                    </a>

                    <div class="l3 collapsed expanded">
                        <a href="docs-getstarted.html#crud" class="title">
                            <span class="bullet"></span>
                            <span class="text">2.4 CRUD in ActorDB</span>
                        </a>
                        <a href="docs-getstarted.html#create" class="text last">2.4.1 Create</a>
                        <a href="docs-getstarted.html#read" class="text last">2.4.2 Reading actors and tables</a>
                        <a href="docs-getstarted.html#update" class="text last">2.4.3 Updating tables in actors</a>
                        <a href="docs-getstarted.html#delete" class="text last">2.4.4 Deleting tables in actors and actors itself</a>
                    </div>
                </div>
            </div>
            <div class="l1 collapsed expanded">
                <a href="docs-howitworks.html" class="title">
                    <span class="bullet"></span>
                    <span class="text">3. HOW IT WORKS</span>
                </a>
                <div class="l2">
                    <a href="docs-howitworks.html#overview" class="title">
                        <span class="text">3.1 Overview</span>
                    </a>
                    <div class="l3 collapsed expanded">
                        <a href="docs-howitworks.html#nodesyny" class="title">
                            <span class="bullet"></span>
                            <span class="text">3.2 Node synchronisation</span>
                        </a>
                        <a href="docs-howitworks.html#h_321" class="text last">3.2.1 Global state</a>
                        <a href="docs-howitworks.html#h_322" class="text last">3.2.2 Actors</a>
                        <a href="docs-howitworks.html#h_323" class="text last">3.2.3 Multi-actor transactions</a>
                    </div>
                    <a href="docs-howitworks.html#dbengine" class="title">
                        <span class="text">3.3 SQL engine</span>
                    </a>
                </div>
            </div>
            <div class="l1 collapsed ">
                <a href="docs-querymodel.html" class="title">
                    <span class="bullet"></span>
                    <span class="text">4. QUERY MODEL</span>
                </a>
                <div class="l2">
                    <div class="l3 collapsed expanded">
                        <a href="docs-querymodel.html#query_actor" class="title">
                            <span class="bullet"></span>
                            <span class="text">4.1 ACTOR statement</span>
                        </a>
                        <a href="docs-querymodel.html#h_411" class="last">4.1.1 Single actor</a>
                        <a href="docs-querymodel.html#h_412" class="last">4.1.2 Multiple actors</a>
                        <a href="docs-querymodel.html#h_413" class="last">4.1.3 All actors of a type</a>
                        <a href="docs-querymodel.html#h_414" class="last">4.1.4 Loop over actors</a>
                    </div>
                </div>
                <div class="l2">
                    <div class="l3 collapsed expanded">
                        <a href="docs-querymodel.html#query_variables" class="title">
                            <span class="bullet"></span>
                            <span class="text">4.2 Variables</span>
                        </a>
                        <a href="docs-querymodel.html#h_421" class="last">4.2.1 Appending columns to result</a>
                    </div>
                    
                        
                </div>
               
                        <a href="docs-querymodel.html#query_pragma" class="last">
                            
                            <span class="text">4.3 Pragma statement</span>
                        </a>
                   

            </div>


            <div class="l1">
                <div class="l3 collapsed ">
                        <a href="docs-kvstore.html" class="title">
                            <span class="bullet"></span>
                            <span class="text">5. KEY/VALUE STORE</span>
                        </a>
                        <a href="docs-kvstore.html#about_kv_store" class="last">5.1 About</a>
                        <a href="docs-kvstore.html#reliable_distributed_counters" class="last">5.2 Use case: reliable distributed counters</a>
                </div>
                

                
            </div>
           
            <div class="l1 collapsed ">
                <a href="docs-examples.html" class="title">
                    <span class="bullet"></span>
                    <span>6. EXAMPLES</span>
                </a>
                <!-- <a href="docs-examples.html" class="last">
                    <span>Introduction</span>
                </a> -->
                <a href="docs-examples.html#example_filesync" class="last">
                    <span>6.1 File sync</span>
                </a>
            </div>

            <div class="l1 collapsed ">
            <!-- <div class="l1"> -->
                <a href="docs-configuration.html" class="title">
                    <span class="bullet"></span>
                    <span class="text">7. CONFIGURATION</span>
                </a>
                <a href="docs-configuration.html#conf_files" class="last">
                    <span>7.1 ActorDB configuration files</span>
                </a>
                <a href="docs-configuration.html#conf_nodes" class="last">
                    <span>7.2 init.sql</span>
                </a>
                <a href="docs-configuration.html#setup_guide" class="last">
                    <span>7.3 Setup guide</span>
                </a>
                <a href="docs-configuration.html#changing_schema" class="last">
                    <span>7.4 Changing schema</span>
                </a>
                <a href="docs-configuration.html#adding_cluster" class="last">
                    <span>7.5 Adding a cluster</span>
                </a>
                <a href="docs-configuration.html#building_actordb" class="last">
                    <span>7.6 Building ActorDB</span>
                </a>
                <a href="docs-configuration.html#running_dev_mode" class="last">
                    <span>7.7 Running ActorDB development mode</span>
                </a>
            </div>

            <!-- <div class="l1"> -->
            <div class="l1 collapsed ">
                <a href="docs-faq.html" class="title">
                    <span class="bullet"></span>
                    <span class="text">8. FAQ</span>
                </a>
                <a href="docs-faq.html#storage" class="last">
                    <span>8.1 Storage/Hardware</span>
                </a>
                <a href="docs-faq.html#clustering" class="last">
                    <span>8.2 Clustering</span>
                </a>
                <a href="docs-faq.html#querying" class="last">
                    <span>8.3 Querying</span>
                </a>
            </div>
        </div>
        <div class="content">

   				<h1 id="howitworks" class="pagetitle">3. How it works</h1>


<h2 id="overview" class="pagesubtitle">3.1 Overview</h2>
<div class="clearfix imgholder">
    <img class="img_left" src="imgs/single_cluster.png" alt=""/>
    <img class="img_right" src="imgs/multiple_cluster.png" alt=""/>
</div>
    <p class="pagetext"></p>
    <p class="pagetext">ActorDB is organised into clusters (1,3,5 nodes). There can be as many clusters as you wish. Actors themselves are organised into shards. Logically a shard is a chunk of hash namespace. It is a special type of actor that holds a list of regular actors. Shards live within clusters and so do their actors.</p>

    <p class="pagetext">An actor is a mini fully relational SQL database. It has a leader node that processes reads and writes, it has follower nodes on other servers in the cluster that receive writes from leader. Writes are replicated using the Raft distributed consensus protocol. If a server is offline, one of the followers will automatically become a leader for that actor. As long as a majority of servers in a cluster are online, writes will succeed. </p>

    <p class="pagetext">A single actor is not scalable, it is fast enough. A single actor can do thousands of writes per second and tens of thousands of reads. The database as a whole is completely horizontally scalable, because actors are independent of each other.</p>

<hr class="hr14color" />

<h2 id="nodesyny" class="pagesubtitle">3.2 Node synchronisation</h2>
<h3 id="h_321" class="pagesubtitle">3.2.1 Global state</h3>
    <p class="pagetext">ActorDB is designed around having to do the least possible inter-server synchronisation. That means each server should be as independent as possible and global state and the changing of that global state should be minimised. </p>
    <p class="pagetext">Everything in ActorDB is an actor. This includes global state. It is a special actor that lives on up to 7 nodes (over multiple clusters). Those 7 nodes maintain strong consistency using Raft distributed consensus. If ActorDB has more than 7 nodes, the rest get their state by periodic pings from current leader node.</p>
    <p class="pagetext">Global state for ActorDB:</p>
    <div class="pagetext">
        <ol>
            <li>1. List of nodes (changed manually by user).</li>
            <li>2. Database schema (changed manually by user).</li>
            <li>3. List of shards and which node owns which shard (caused by change in list of nodes).</li>
            <li>4. uniqid current max value (set automatically).</li>
            <li>5. List of nodes that are part of the global state group.</li>
        </ol>
    </div>

    <p class="pagetext"></p>
    <hr class="hr14colorsmalmargin" />

    <h3 id="h_322" class="pagesubtitle">3.2.2 Actors</h3>

    <p class="pagetext">All ActorDB requests are always sent to an actor. Steps from receiving request sending request to actor:</p>
    <div class="pagetext">
        <ol>
            <li>1. Calculate a hash of actor name.</li>
            <li>2. Check the hash table of shards to find which node that actor lives in.</li>
            <li>3. Send request to what should be leader node.</li>
            <li>4. If what should be leader node is actually not, request will be redirected to the actual leader.</li>
        </ol>
    </div>
    <p class="pagetext">ActorDB has two distinct engines: SQLite for running SQL queries and LMDB for storage. The SQL engine uses pages to store data (chunks of 4096 bytes). Those pages are not stored to SQLite files, they are stored inside LMDB. We replaced the SQLite WAL implementation with our own, which is actually faster on an individual actor basis then just using SQLite. Unlike regular WAL mode we do not need to checkpoint pages somewhere else later on. Once a page is stored, it is kept where it is. It is also compressed using lz4.</p>
    <p class="pagetext"></p>
    <p class="pagetext">Unlike most other databases (especially SQL databases), ActorDB does not require checkpoints from WAL to the main database file. Using LMDB we are able to store pages in an append-only style. This way checkpoints are replaced with cleanups that only free up space for later use.</p>
    <p class="pagetext"></p>
    <p class="pagetext">Actors are replicated using the Raft distributed consensus protocol. Raft requires a write log to operate. Because our two engines are connected through the SQLite WAL module, Raft replication is a natural fit. Every write to the database is an append to WAL. For every append we send that data to the entire cluster to be replicated. Pages are simply inserted to WAL on all nodes. This means the leader executes the SQL, but the followers just append to WAL. </p>
    <p class="pagetext"></p>
    <p class="pagetext">If a server is very stale or is added new, ActorDB will first send the base actor pages to the new server, then it will send the WAL pages (if there are any). </p>
    <p class="pagetext"></p>
    <p class="pagetext">You can configure the server to use multiple independent hard drives and ActorDB will balance actors across all of them. This will significantly improve throughput as long as cpu and network are not saturated.</p>

    <hr class="hr14colorsmalmargin" />
<h3 id="h_323" class="pagesubtitle">3.2.3 Multi-actor transactions</h3>

<p class="pagetext">Multi-actor transactions need to be ACID compliant. They are executed by a transaction manager. The manager is itself an actor. It has name and a transaction number that is incremented for every transaction.</p>
<p class="pagetext">Sequence of events from the transaction manager point of view:</p>
<div class="pagetext">
    <ol>
        <li>1. Start transaction by writing the number and state (uncommitted) to transaction table of transaction manager actor.</li>
<li>2. Go through all actors in the transaction and execute their belonging SQL to check if it can execute, but do not commit it. If actor successfully executes SQL it will lock itself (queue all reads and writes).</li>
<li>3. All actors returned success. Change state in transaction table for transaction to committed. </li>
<li>4. Inform all actors that they should commit.</li>
    </ol>
</div>
<p class="pagetext"></p>
<p class="pagetext">Sequence of events from an actors point of view:</p>
<div class="pagetext">
    <ol>
        <li>1. Actor receives SQL with a transaction ID, transaction number and which node transaction manager belongs to. </li>
<li>2. Store the actual SQL statement with transaction info to a transaction table (not execute it). </li>
<li>3. Once it is stored, the SQL will be executed but not committed. If there was no error, return success.</li>
<li>4. Actor waits for confirm or abort from transaction manager. It will also periodically check back with the transaction manager in case the node where it was running from went down and confirmation message is lost.</li>
<li>5. Once it has a confirmation or abort message it executes it and unlocks itself.</li>
    </ol>
</div>
<p class="pagetext"></p>
<p class="pagetext">Problem scenarios:</p>
<div class="pagetext">
    <ol>
        <li>1. Node where transaction manager lives goes down before committing transaction: Actors will be checking back to see what state a transaction is in. If transaction manager actor resumes on another node and sees an uncommitted transaction, it will mark it as aborted. Actors will in turn abort the transaction as well.</li>
<li>2. Node where transaction manager lives goes down after committing transaction to local state, but before informing actors that transaction was confirmed. Actors checking back will detect a confirmed transaction and commit it.</li>
<li>3. Node where one or more actors live goes down after confirming that they can execute transaction. The actual SQL statements are stored in their databases. The next time actors start up, they will notice that transaction. Check back with the transaction manager and either commit or abort it.</li>
    </ol>
</div>
<p class="pagetext"></p>
</p>
<p class="pagetext"></p>
<hr class="hr14color" />

<h2 id="dbengine" class="pagesubtitle">3.3 SQL engine</h2>

<p class="pagetext">ActorDB does not reinvent the SQL engine. It relies on one of the most well tested and stable pieces of code in use: SQLite</p>

<p class="pagetext">Remember that SQLite is not itself a separate program. It is a software library which is a part of ActorDB. Running many or just one actor on a server does not make a difference. There is no global SQLite lock that blocks one actor from doing work because another is using it.</p>

<p class="pagetext">ActorDB can easily handle thousands of requests per second for a single actor. For our purposes SQLite is an ideal engine.</p>

<p class="pagetext">
SQLite provides a list of cases where its use is not recommended. <b>None of them apply to ActorDB</b> (<a href="https://www.sqlite.org/whentouse.html">https://www.sqlite.org/whentouse.html</a>).<br/>
<br/>
<b>Client/Server Applications</b> - ActorDB takes care of the network protocol. It is very suitable for a client/server application over the network.<br/>
<b>High-volume Websites</b> - ActorDB is able to spread the load across as many servers and SQLite instances as you throw at it. It will thus be very suitable for high-volume websites. <br/>
<b>Very large datasets</b> - As long as you do not have a very large dataset inside a single actor (many GB) and spread the data across many actors, ActorDB will work very well even with petabytes of data.<br/>
<b>High Concurrency</b> - ActorDB is massively concurrent. Not on the individual actor level, but across the entire database. </p>




<div class="pageactions">
    <span class="goleft"><a href="docs-getstarted.html"><span class="pagebtn"><< Previous</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2. Get started)</span>
    <span class="goright">(4. Query model)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="docs-querymodel.html"><span class="pagebtn">Next >></span></a></span>
</div>

<p class="pagetext"></p>


   			<p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>
            <p class="pagetext">&nbsp;</p>

        </div>
    </div>
</div>

        <div class="footer">
            <div class="pagewrapper">
                <div class="linkholder">
                    <a href="https://www.github.com/biokoda/actordb" class="link">GitHub</a>
                    <a href="https://github.com/biokoda/actordb/issues" class="link">Issues</a>
                    <a href="https://github.com/biokoda/actordb/blob/master/README.md" class="link marginrightzero">Changelog</a>
                </div>
                <p class="text">Product by Biokoda. <br/ >
                    Licensed under Mozilla Public License 2.0.
                </p>
                <a class="global-footer_logo"></a>        
            </div>
        </div>

        <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>-->
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        
        <script type="text/javascript">
            var isAtLeastIE11 = !!(navigator.userAgent.match(/Trident/) && !navigator.userAgent.match(/MSIE/));
            if (isAtLeastIE11) {
                $("html").addClass("ieedge");
            }
            if (navigator.platform.indexOf("Win") != -1 && navigator.userAgent.indexOf("MSIE") != -1 || navigator.platform.indexOf("Win") != -1 && isAtLeastIE11){
                $("html").addClass("iecomm");
            } 
            if (navigator.platform.indexOf("Win") !=-1 && navigator.userAgent.indexOf("Chrome") != -1) {
                $("html").addClass("winchrome");
            }
        </script>
        <!--<script src="js/actordb-website.js"></script>-->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47379916-1', 'actordb.com');
          ga('send', 'pageview');

        </script>
    </body>
</html>
